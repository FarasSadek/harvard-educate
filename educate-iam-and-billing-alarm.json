{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"AWS CloudFormation Template educage-iam-and-billing-alarm: Creates default IAM User and Billing Alarm **WARNING** You will be billed for the AWS resources used if you create a stack from this template.",
   "Parameters":{  
      "BillingNotificationEmail":{  
         "Type":"String",
         "Default":"aws-admin@seas.harvard.edu"
      },
      "BillingAlarmThreshold":{  
         "Type":"Number",
         "Default":"75"
      },
      "UserName":{  
         "Type":"String",
         "Default":"harvarduser"
      }
   },
   "Resources":{  
      "IAMUserName":{  
         "Type":"AWS::IAM::User",
         "Properties":{  
            "Path":"/",
            "LoginProfile":{  
               "Password":{  
                  "Ref":"$IAMUserName"
               }
            },
            "Policies":[  
               {  
                  "PolicyName":"poweruseraccess",
                  "PolicyDocument":{  
                     "Version":"2012-10-17",
                     "Statement":[  
                        {  
                           "Effect":"Allow",
                           "Action":[  
                              "*"
                           ],
                           "Resource":[  
                              "*"
                           ]
                        },
                        {  
                           "Effect":"Deny",
                           "Action":[  
                              "iam:*"
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      },
      "BillingAlarmNotification":{  
         "Type":"AWS::SNS::Topic",
         "Properties":{  
            "Subscription":[  
               {  
                  "Endpoint":{  
                     "Ref":"BillingNotificationEmail"
                  },
                  "Protocol":"email"
               }
            ]
         }
      },
      "SpendingAlarm":{  
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{  
            "AlarmDescription":{  
               "Fn::Join":[  
                  "",
                  [  
                     "Alarm if AWS spending is over $",
                     {  
                        "Ref":"BillingAlarmThreshold"
                     }
                  ]
               ]
            },
            "Namespace":"AWS/Billing",
            "MetricName":"EstimatedCharges",
            "Dimensions":[  
               {  
                  "Name":"Currency",
                  "Value":"USD"
               }
            ],
            "Statistic":"Maximum",
            "Period":"21600",
            "EvaluationPeriods":"1",
            "Threshold":{  
               "Ref":"AlarmThreshold"
            },
            "ComparisonOperator":"GreaterThanThreshold",
            "AlarmActions":[  
               {  
                  "Ref":"BillingAlarmNotification"
               }
            ],
            "InsufficientDataActions":[  
               {  
                  "Ref":"BillingAlarmNotification"
               }
            ]
         }
      }
   }
}
